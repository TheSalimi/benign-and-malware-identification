using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using System.Text;

namespace Benign_Malware_identification
{
    class Program
    {
        static List<string> pages = new List<string>();
        static List<string> malwarePatterns = new List<string>();
        static void Main()
        {
            //find malware pages and add their hex values to the page list
            FindPages(@"G:\University\Algorithms\project\Released\Train\Malware Sample");
            FindPages(@"G:\University\Algorithms\project\Released\Train\Malware Sample2");

            for (int i = 0; i < pages.Count-2; i+=2)
            {
                string first1500Characters1 = pages[i].Substring(0, Math.Min(pages[i].Length, 1000));
                string first1500Characters2= pages[i].Substring(0, Math.Min(pages[i+1].Length, 1000));

                malwarePatterns.Add(LongestCommonSubstring(first1500Characters1, first1500Characters2));
            }
        }

        public static string LongestCommonSubstring(string str1, string str2)
        {
            int m = str1.Length;
            int n = str2.Length;

            // Create a matrix to store the lengths of longest common suffixes
            // of substrings. Initialize all values to 0.
            int[,] dp = new int[m + 1, n + 1];

            // Variables to store the length of the longest common substring
            // and its ending position in the strings.
            int maxLength = 0;
            int endPos = 0;

            // Iterate over the strings to fill the dp matrix
            for (int i = 1; i <= m; i++)
            {
                for (int j = 1; j <= n; j++)
                {
                    if (str1[i - 1] == str2[j - 1])
                    {
                        dp[i, j] = dp[i - 1, j - 1] + 1;
                        if (dp[i, j] > maxLength)
                        {
                            maxLength = dp[i, j];
                            endPos = i;
                        }
                    }
                }
            }

            // Extract the longest common substring using the end position and length
            string longestSubstring = str1.Substring(endPos - maxLength, maxLength);

            return longestSubstring;
        }

        public static void FindPages(string baseAddress)
        {
            for (int i = 1; i < 21; i++)
            {
                int pageNum = 0;
                string folderNumber = @$"\{i}";
                string[] malware1FilePaths = Directory.GetFiles(@$"{baseAddress}\{i}");
                foreach (string currentFile in malware1FilePaths)
                {
                    byte[] Bytes = File.ReadAllBytes(currentFile);
                    pages.Add(ConvertByteToHex(Bytes));
                    pageNum++;
                    if (pageNum == 2) //just first 2 page of malware folder
                        break;
                }
            }
        }

        public static string ConvertByteToHex(byte[] byteData)
        {
            string hexValues = BitConverter.ToString(byteData).Replace("-", "");
            //string text = Encoding.ASCII.GetString(HexStringToBytes(hexValues));
            return hexValues;
        }

       /* public static byte[] HexStringToBytes(string hexString)
        {
            if (hexString == null)
                throw new ArgumentNullException("hexString");
            if (hexString.Length % 2 != 0)
                throw new ArgumentException("hexString must have an even length", "hexString");
            var bytes = new byte[hexString.Length / 2];
            for (int i = 0; i < bytes.Length; i++)
            {
                string currentHex = hexString.Substring(i * 2, 2);
                bytes[i] = Convert.ToByte(currentHex, 16);
            }
            return bytes;
        } */
    }
}